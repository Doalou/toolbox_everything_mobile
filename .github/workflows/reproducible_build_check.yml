name: ğŸ” Reproducible Build Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # VÃ©rification hebdomadaire (dimanche Ã  3h00 UTC)
    - cron: '0 3 * * 0'

jobs:
  reproducible_build_verification:
    name: VÃ©rification des Builds Reproductibles
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # RÃ©cupÃ¨re l'historique complet pour GIT_COMMIT
    
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: ğŸ“± Setup Android NDK
      run: |
        echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/27.3.13750724" >> $GITHUB_ENV
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "ndk;27.3.13750724" || echo "NDK dÃ©jÃ  installÃ©"
    
    - name: ğŸ”§ Configure l'environnement reproductible
      run: |
        echo "SOURCE_DATE_EPOCH=1704067200" >> $GITHUB_ENV
        echo "GIT_COMMIT=${{ github.sha }}" >> $GITHUB_ENV
        echo "TZ=UTC" >> $GITHUB_ENV
    
    - name: ğŸ“¦ Cache des dÃ©pendances
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.pub-cache
        key: ${{ runner.os }}-build-cache-${{ hashFiles('**/pubspec.lock', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-build-cache-
    
    - name: ğŸ—ï¸ Premier build reproductible
      run: |
        echo "ğŸ”¨ Premier build en cours..."
        flutter clean
        flutter pub get
        flutter build apk --release --split-per-abi
        
        # Sauvegarde des artefacts
        mkdir -p reproducible_builds/build1
        cp build/app/outputs/flutter-apk/*.apk reproducible_builds/build1/
        
        # Calcul des checksums
        cd reproducible_builds/build1
        sha256sum *.apk > checksums_build1.txt
        echo "âœ… Premier build terminÃ©"
    
    - name: â±ï¸ Pause entre les builds
      run: sleep 5
    
    - name: ğŸ—ï¸ DeuxiÃ¨me build reproductible
      run: |
        echo "ğŸ”¨ DeuxiÃ¨me build en cours..."
        flutter clean
        flutter pub get
        flutter build apk --release --split-per-abi
        
        # Sauvegarde des artefacts
        mkdir -p reproducible_builds/build2
        cp build/app/outputs/flutter-apk/*.apk reproducible_builds/build2/
        
        # Calcul des checksums
        cd reproducible_builds/build2
        sha256sum *.apk > checksums_build2.txt
        echo "âœ… DeuxiÃ¨me build terminÃ©"
    
    - name: ğŸ” VÃ©rification de la reproductibilitÃ©
      run: |
        
        echo "ğŸ“Š Comparaison des builds..."
        echo "=========================="
        
        # Comparaison des checksums
        if diff -u reproducible_builds/build1/checksums_build1.txt reproducible_builds/build2/checksums_build2.txt; then
          echo "âœ… SUCCÃˆS : Les builds sont identiques !"
          echo "ğŸ‰ Configuration reproductible validÃ©e."
          echo "reproducible=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Ã‰CHEC : Les builds diffÃ¨rent"
          echo "Build 1 checksums:"
          cat reproducible_builds/build1/checksums_build1.txt
          echo ""
          echo "Build 2 checksums:"
          cat reproducible_builds/build2/checksums_build2.txt
          echo "reproducible=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Comparaison des tailles
        echo ""
        echo "ğŸ“ Comparaison des tailles :"
        echo "============================"
        for apk in reproducible_builds/build1/*.apk; do
          filename=$(basename "$apk")
          size1=$(stat -c%s "reproducible_builds/build1/$filename")
          size2=$(stat -c%s "reproducible_builds/build2/$filename")
          size_diff=$((size2 - size1))
          
          printf "ğŸ“± %-40s\n" "$filename"
          printf "   Build 1: %8.2f MB\n" "$(echo "scale=2; $size1/1024/1024" | bc)"
          printf "   Build 2: %8.2f MB\n" "$(echo "scale=2; $size2/1024/1024" | bc)"
          
          if [ $size_diff -eq 0 ]; then
            printf "   âœ… Identique (0 bytes de diffÃ©rence)\n"
          else
            printf "   âŒ DiffÃ©rence: %d bytes\n" $size_diff
          fi
          echo ""
        done
    
    - name: ğŸ“¤ Upload des artefacts de comparaison
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: reproducible-builds-verification-${{ github.sha }}
        path: |
          reproducible_builds/
        retention-days: 7
    
    - name: ğŸ’¬ Commentaire sur la PR (si Ã©chec)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âŒ Ã‰chec de la vÃ©rification des Builds Reproductibles
            
            Les deux builds successifs ont produit des binaires diffÃ©rents. Cela peut indiquer :
            
            - ğŸ• Des timestamps non fixes
            - ğŸ“ Un ordre de fichiers non dÃ©terministe  
            - ğŸ”§ Des variables d'environnement changeantes
            - ğŸ² Une source de non-dÃ©terminisme dans le build
            
            Consultez les logs de l'action pour plus de dÃ©tails et le guide \`docs/REPRODUCIBLE_BUILDS.md\`.
            
            **Artefacts disponibles** : Les APKs des deux builds sont disponibles dans les artefacts de cette action pour analyse manuelle.`
          })
    
    - name: âœ… Commentaire de succÃ¨s sur la PR
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âœ… Builds Reproductibles ValidÃ©s !
            
            ğŸ‰ Les deux builds successifs ont produit des binaires **identiques**.
            
            Votre configuration garantit des builds reproductibles, ce qui renforce :
            - ğŸ”’ La sÃ©curitÃ© (vÃ©rification binaire/source)
            - ğŸ› Le dÃ©bogage (comparaisons fiables)
            - ğŸ“‹ La conformitÃ© aux standards
            
            **Checksums identiques** âœ“  
            **Tailles identiques** âœ“  
            **Configuration dÃ©terministe** âœ“`
          })
