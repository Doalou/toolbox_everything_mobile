name: ğŸ§ª Test Build Simple

on:
  workflow_dispatch:  # DÃ©clenchement manuel pour les tests
  push:
    branches: [ main ]

jobs:
  test_build:
    name: Test Build Basic
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: ğŸ“ VÃ©rification de l'environnement
      run: |
        echo "ğŸ” VÃ©rification de l'environnement..."
        flutter --version
        java -version
        echo "ğŸ“ Contenu du rÃ©pertoire :"
        ls -la
        echo "ğŸ“± SDK Android :"
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
        ls -la $ANDROID_SDK_ROOT/
    
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        echo "ğŸ“¦ Installation des dÃ©pendances Flutter..."
        flutter pub get
        flutter pub deps
    
    - name: ğŸ”§ Configuration reproductible
      run: |
        echo "ğŸ”§ Configuration de l'environnement reproductible..."
        export SOURCE_DATE_EPOCH=1704067200
        export GIT_COMMIT=${{ github.sha }}
        export TZ=UTC
        echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH"
        echo "GIT_COMMIT=$GIT_COMMIT"
        echo "TZ=$TZ"
    
    - name: ğŸ—ï¸ Test build debug
      run: |
        echo "ğŸ—ï¸ Test de build debug..."
        flutter build apk --debug
        echo "âœ… Build debug rÃ©ussi !"
        ls -la build/app/outputs/flutter-apk/
    
    - name: ğŸ“¤ Upload des artefacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-build-${{ github.sha }}
        path: |
          build/app/outputs/flutter-apk/
        retention-days: 1
