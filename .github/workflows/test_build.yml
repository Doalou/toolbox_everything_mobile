name: 🧪 Test Build Simple

on:
  workflow_dispatch:  # Déclenchement manuel pour les tests
  push:
    branches: [ main ]

jobs:
  test_build:
    name: Test Build Basic
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: 📥 Checkout du code
      uses: actions/checkout@v4
    
    - name: ☕ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: 📝 Vérification de l'environnement
      run: |
        echo "🔍 Vérification de l'environnement..."
        flutter --version
        java -version
        echo "📁 Contenu du répertoire :"
        ls -la
        echo "📱 SDK Android :"
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
        ls -la $ANDROID_SDK_ROOT/
    
    - name: 📦 Installation des dépendances
      run: |
        echo "📦 Installation des dépendances Flutter..."
        flutter pub get
        flutter pub deps
    
    - name: 🔧 Configuration reproductible
      run: |
        echo "🔧 Configuration de l'environnement reproductible..."
        export SOURCE_DATE_EPOCH=1704067200
        export GIT_COMMIT=${{ github.sha }}
        export TZ=UTC
        echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH"
        echo "GIT_COMMIT=$GIT_COMMIT"
        echo "TZ=$TZ"
    
    - name: 🏗️ Test build debug
      run: |
        echo "🏗️ Test de build debug..."
        flutter build apk --debug
        echo "✅ Build debug réussi !"
        ls -la build/app/outputs/flutter-apk/
    
    - name: 📤 Upload des artefacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-build-${{ github.sha }}
        path: |
          build/app/outputs/flutter-apk/
        retention-days: 1
